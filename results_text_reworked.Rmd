---
title: "Climate impacts on zoonotic disease meta-analysis: text"
output:
  html_notebook: 
    theme: flatly
    fig_caption: yes
  html_document: 
    keep_md: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE, results='asis'}
# depss

if (!require(tidyverse, quietly = TRUE)) {
  install.packages("tidyverse")
  library(tidyverse)
}

if (!require(twosamples, quietly = TRUE)) {
  install.packages("twosamples")
  library(twosamples)
}

if (!require(magrittr, quietly = TRUE)) {
  install.packages("magrittr")
  library(magrittr)
}

if (!require(knitr, quietly = TRUE)) {
  install.packages("library(knitr)")
  library(knitr)
}

if (!require(ggpubr, quietly = TRUE)) {
  install.packages("library(ggpubr)")
  library(ggpubr)
}

if (!require(metafor, quietly = TRUE)) {
  install.packages("metafor")
  library(metafor)
}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, include=FALSE)

# load dataset
df = read.csv('data/dataset_final.csv')

# change vector names
df = df%>%
  mutate(Transmission_type = ifelse(Transmission_type == 'HVH', 'Vectored', 'Non-vectored'))

# add parasite group
df = df%>%
  mutate(Pathogen = ifelse(Pathogen == 'P', 'Parasite',
                                ifelse(Pathogen == 'V', 'Virus',
                                        'Bacteria')))
# keep only unique rows
df = unique(df)
```

## Literature search results

```{r}
extracted_stats = df %>% filter(!is.na(Value))
extracted_stats %<>% 
  select(Environmental_condition) %>% 
  count(Environmental_condition) %>% 
  group_by(Environmental_condition) %>% 
  mutate(prop = n/length(extracted_stats$Environmental_condition))

disease_txt = df%>%
  filter(General_Disease != "Multiple") %>%
  group_by(General_Disease) %>%
  summarise(N = n_distinct(Reference_ID)) %>%#
  mutate(P = N/sum(N))%>%
  arrange(desc(N))

linear_nonlinear = df%>%
  group_by(Linear_Nonlinear) %>%
  summarise(N = n_distinct(Reference_ID)) %>%#
  mutate(P = N/sum(N))%>%
  arrange(desc(N)) 
```

The search criteria isolated 13,468 article titles, which were narrowed down through a four-step screening process (Fig. S1) to `r length(unique(df$Reference_ID))` (1.3 % of total) independent, empirical studies that could be included in the final dataset. These studies, representing `r length(unique(df$Disease))` diseases (Table S12) from `r length(unique(df$Country))` countries, provided `r length(df$Value[!is.na(df$Value)])` statistics quantifying the relationship between climate variables and zoonotic disease risk. Temperature was the most commonly studied variable `r paste0("(",paste0(round(extracted_stats$prop[extracted_stats$Environmental_condition=="Temperature"],2)*100,"%"),", ","n=",extracted_stats$n[extracted_stats$Environmental_condition=="Temperature"],")")`, followed by precipitation `r paste0("(",paste0(round(extracted_stats$prop[extracted_stats$Environmental_condition=="Precipitation"],2)*100,"%"),", ","n=",extracted_stats$n[extracted_stats$Environmental_condition=="Precipitation"],")")`, and humidity `r paste0("(",paste0(round(extracted_stats$prop[extracted_stats$Environmental_condition=="Humidity"],2)*100,"%"),", ","n=",extracted_stats$n[extracted_stats$Environmental_condition=="Humidity"],")")`. The studies had close to global coverage, with areas of high sampling in South and East Asia and Europe, and more limited sampling in Central and North Asia and Eastern Africa (Fig. 1A). Hantaviruses were the most frequently studied pathogens `r paste0("(",paste0(round(disease_txt$P[disease_txt$General_Disease=="Hantaviral diseases"],3)*100,"%"),", ","n=",disease_txt$N[disease_txt$General_Disease=="Hantaviral diseases"],")")`, followed by arboviruses `r paste0("(",paste0(round(disease_txt$P[disease_txt$General_Disease=="Arboviral diseases"],3)*100,"%"),", ","n=",disease_txt$N[disease_txt$General_Disease=="Arboviral diseases"],")")` and leptospirosis `r paste0("(",paste0(round(disease_txt$P[disease_txt$General_Disease=="Leptospirosis"],3)*100,"%"),", ","n=",disease_txt$N[disease_txt$General_Disease=="Leptospirosis"],")")` (see Fig. 1B).


## Key findings and emerging patterns among climatic factors
```{r reppvalsignificance_text, include=FALSE}

#filter out records without P values 
pvals = df %>% filter(P.value_general!="" & !is.na(P.value_general))

#unify P-values
pvals$P.value_general[pvals$P.value_general=="<.0.05" |
                    pvals$P.value_general=="<0..05"] = "<0.05"
pvals = as.data.frame(table(pvals$P.value_general)); names(pvals) = c("pval","freq")

# Calculate proportions
pvals %<>% mutate(P = freq/sum(freq))

# Proportion of studies with P-values at different levels
alfa_005_p = pvals %>% filter(pval!=">0.05") %>% summarise(total_sum = sum(P, na.rm = TRUE)) %>% pull(total_sum)

alfa_001_p = pvals %>% filter(!pval %in% c("<0.05",">0.05")) %>% summarise(total_sum = sum(P, na.rm = TRUE)) %>% pull(total_sum)

alfa_0001_p = pvals %>% filter(!pval %in% c("<0.05",">0.05","<0.01")) %>% summarise(total_sum = sum(P, na.rm = TRUE)) %>% pull(total_sum)
```

```{r hedges_summary}
df = df %>%
  mutate(es_cat = ifelse(es < -0.2, 'Negative effect (g < -0.2)', #if CI contains 0
                         ifelse(abs(es) < 0.2, 'No effect', # otherwise negative
                                'Positive effect (g > 0.2)'))) # or positive
es_categories = df %>%
  subset(Linear_Nonlinear == 'Linear')%>%
  count(es_cat, Environmental_condition)%>%
  group_by(Environmental_condition)%>%
  mutate(prop = n /sum(n), tot = sum(n))

# summary tables 

# full dataset
tmp_all <- es_categories %>%
  group_by(es_cat) %>%
  summarise(total_n = sum(n)) %>%
  mutate(prop = total_n / sum(total_n))

tmp_comb_all <- tmp_all %>%
  mutate(effect_type = ifelse(es_cat == 'No effect', 'No effect', 'Non-zero effect')) %>%
  group_by(effect_type) %>%
  summarise(total_n = sum(total_n)) %>%
  mutate(prop = total_n / sum(total_n))

# temperature
tmp_temp <- es_categories %>%
  filter(Environmental_condition=="Temperature") %>% 
  group_by(es_cat) %>%
  summarise(total_n = sum(n)) %>%
  mutate(prop = total_n / sum(total_n))

tmp_comb_temp <- tmp_temp %>%
  mutate(effect_type = ifelse(es_cat == 'No effect', 'No effect', 'Non-zero effect')) %>%
  group_by(effect_type) %>%
  summarise(total_n = sum(total_n)) %>%
  mutate(prop = total_n / sum(total_n))

# precipitation
tmp_prec <- es_categories %>%
  filter(Environmental_condition=="Precipitation") %>% 
  group_by(es_cat) %>%
  summarise(total_n = sum(n)) %>%
  mutate(prop = total_n / sum(total_n))

tmp_comb_prec <- tmp_prec %>%
  mutate(effect_type = ifelse(es_cat == 'No effect', 'No effect', 'Non-zero effect')) %>%
  group_by(effect_type) %>%
  summarise(total_n = sum(total_n)) %>%
  mutate(prop = total_n / sum(total_n))

# humidity
tmp_hum <- es_categories %>%
  filter(Environmental_condition=="Humidity") %>% 
  group_by(es_cat) %>%
  summarise(total_n = sum(n)) %>%
  mutate(prop = total_n / sum(total_n))

tmp_comb_hum <- tmp_hum %>%
  mutate(effect_type = ifelse(es_cat == 'No effect', 'No effect', 'Non-zero effect')) %>%
  group_by(effect_type) %>%
  summarise(total_n = sum(total_n)) %>%
  mutate(prop = total_n / sum(total_n))

paste0(round(tmp_comb_all$prop[tmp_comb_all$effect_type=="Non-zero effect"],2)*100,"%")
paste0(round(tmp_comb_temp$prop[tmp_comb_temp$effect_type=="Non-zero effect"],3)*100,"%")
```



In general, temperature, rainfall and humidity influence zoonotic disease risk, according to the majority of studies assessed (`r paste0(round(alfa_005_p,3)*100, "%")` significant at α=0.05, `r paste0(round(alfa_001_p,2)*100, "%")` at α=0.01, `r paste0(round(alfa_0001_p,2)*100, "%")` at α=0.001). Standardising the statistics extracted from the studies by transforming them into Hedge’s g  showed that most studies  [`r paste0(round(tmp_comb_all$prop[tmp_comb_all$effect_type=="Non-zero effect"],2)*100,"%")` Non-zero effect sizes, STAT FOR WHOLE DATASET] reported non-zero effects more often than no effect of climate measures on zoonotic risk [CHECK] (Fig. 2). However, when splitting the dataset into the three climate measures separately only temperature had more positive or negative effects compared to no effects [`r paste0(round(tmp_comb_temp$prop[tmp_comb_temp$effect_type=="Non-zero effect"],3)*100,"%")` Non-zero effect sizes, STAT], with over half of the studies reporting no effect of precipitation  (`r paste0(round(tmp_comb_prec$prop[tmp_comb_prec$effect_type=="No effect"],3)*100,"%","; n=",tmp_comb_prec$total_n[tmp_comb_prec$effect_type=="No effect"])`) or humidity (`r paste0(round(tmp_comb_hum$prop[tmp_comb_hum$effect_type=="No effect"],3)*100,"%","; n=",tmp_comb_hum$total_n[tmp_comb_hum$effect_type=="No effect"])`
) on disease risk. When broken down for each of the separate climate factors the majority of subcategories of the data followed a similar effect size distribution as for the full dataset, with similar numbers of negative and positive effects (Fig. 2).


### **Positive Temperature effects**
```{r AD_KS_TESTS}
source('AD_KS_tests.R')
# Creates: 
# - results_df (for AD tests)
# - es_summaries (for KS)
# - pvals_ks (for KS)
# - test_stats_ks (for KS)
results_df
es_summaries
pvals_ks
test_stats_ks

```
Temperature emerged as an important factor in influencing the measures of zoonotic risk. Across the three climatic factors investigated, temperature showed the highest proportion of positive effects on measures of disease risk, with `r paste0(round(tmp_temp$prop[tmp_temp$es_cat=="Positive effect (g > 0.2)"],2)*100,"%")` (n=`r tmp_temp$total_n[tmp_temp$es_cat=="Positive effect (g > 0.2)"]`) of studies having a value of Hedge’s g greater than 0.2 (Fig. 2). [**need to mention negative effects being rare**]. Furthermore, the effect size distributions for vector-borne diseases and diseases vectored by mosquitoes significantly differed from the overall effect size distribution for temperature, suggesting a positive influence of temperature on disease risk among these groups (Anderson-Darling Test: vector borne disease: AD = `r round(results_df$stat[results_df$Environmental_condition=="Temperature" & results_df$Group=="Vectored"],2)`; p=`r round(results_df$p_val[results_df$Environmental_condition=="Temperature" & results_df$Group=="Vectored"],3)`; mosquito vectored disease: AD = `r round(results_df$stat[results_df$Environmental_condition=="Temperature" & results_df$Group=="Mosquito"],2)`; p=`r round(results_df$p_val[results_df$Environmental_condition=="Temperature" & results_df$Group=="Mosquito"],3)`). When the subsets were compared to the full distributions with the subset removed, a few more categories were significantly different: non-vectored diseases and diseases with a mammal reservoir significantly differed from the overall temperature distribution (Table S8).
Vector-borne zoonotic diseases had significantly more positive effects (mean=`r round(es_summaries$mn[es_summaries$Transmission_type=="Vectored" & es_summaries$Environmental_condition=="Temperature"],2)`; sd=`r round(es_summaries$sd[es_summaries$Transmission_type=="Vectored" & es_summaries$Environmental_condition=="Temperature"],2)`; n=`r es_summaries$n[es_summaries$Transmission_type=="Vectored" & es_summaries$Environmental_condition=="Temperature"]`) reported for temperature when compared to solely animal-hosted diseases (mean=`r round(es_summaries$mn[es_summaries$Transmission_type=="Non-vectored" & es_summaries$Environmental_condition=="Temperature"],2)`; sd=`r round(es_summaries$sd[es_summaries$Transmission_type=="Non-vectored" & es_summaries$Environmental_condition=="Temperature"],2)`; n=`r es_summaries$n[es_summaries$Transmission_type=="Non-vectored" & es_summaries$Environmental_condition=="Temperature"]`) (Two-sample Kolmogorov-Smirnov test; D=`r round(test_stats_ks$Temperature[[1]],2)`; p = `r round(pvals_ks$Temperature,3)`; Fig. 3).

### **Varied precipitation and humidity effects**
Precipitation and humidity presented a more complex and variable influence on zoonotic disease risk compared to temperature. Effect size distributions for both climatic factors centred around zero, with no significant differences observed between the distributions of vectored and non-vectored subsets (Two-sample Kolmogorov-Smirnov test for precipitation: D=`r round(test_stats_ks$Precipitation[[1]],2)`; p = `r round(pvals_ks$Precipitation,3)`; and humidity: D=`r round(test_stats_ks$Humidity[[1]],2)`; p = `r round(pvals_ks$Humidity,3)`, Fig. 2 & Fig. 3). 
Additionally, the distribution of effect sizes for precipitation had visually larger tails for non-vectored diseases compared to vectored diseases (Fig. 3B), but the available data was too limited to perform statistical tests. Moreover, while majority of observations on the impacts of humidity on disease risk showed no significant effect, a subset of studies focusing on diseases with livestock as the principal reservoir did exhibit a significantly different distribution of effect sizes for humidity (Anderson-Darling Test: AD = `r round(results_df$stat[results_df$Environmental_condition=="Humidity" & results_df$Group=="Livestock"],2)`; p=`r results_df$p_val[results_df$Environmental_condition=="Humidity" & results_df$Group=="Livestock"]`, Fig. 2, Table S10). When the distribution of effect sizes within specific subsets were compared to the full distributions with the subset removed, diseases with a livestock principal reservoir differed from the overall precipitation distribution (Table S9). 

## Inconsistencies, methodological limitations and biases
Several inconsistencies and methodological limitations were identified within the collated dataset and the source studies. While Hedge’s g was able to be calculated for a total of `r sum(!is.na(df$es))` statistics (`r paste0(round(sum(!is.na(df$es))/sum(!is.na(df$Value)),2)*100,"%")` of the extracted statistics), the confidence intervals around Hedge’s g were able to be calculated for only `r df %>% filter(!is.na(ci.lo) & !is.na(ci.hi)) %>% count() %>% pull()` effect sizes, due to limited reporting of statistics within source studies and lack of clearly reported sample sizes, standard errors or confidence intervals.
The dataset analysed contains considerable diversity in both the number of data points per disease and the statistical methods employed across studies. For example, certain diseases including Haemorrhagic fever with renal syndrome (n=28) and Leptospirosis (n=23) were well-represented, while eight diseases (anaplasmosis, bartonellosis, Ebola, MERS, MPox, Q-fever, theileriosis, and toxoplasmosis) were represented by just one study each, limiting generalisability of the analysis. 
In terms of methodology, the collated dataset represented `r length(unique(df$Statistical_method))` specific statistical methods used in the source studies, many of which lacked consistent and detailed reporting of methods used. For example, some methods reported as employed in the studies included minimal description such as “Linear regression”, “Regression analysis”, “Bayesian model”, while others provided more detail including for example “Seasonal autoregressive integrated moving average models” or “Univariate generalised autoregressive poisson regressions”. Furthermore, the use of non-linear models was relatively rare, with only `r paste0(round(linear_nonlinear$P[linear_nonlinear$Linear_Nonlinear=="Non-linear"],3)*100,"%")` (n=`r linear_nonlinear$N[linear_nonlinear$Linear_Nonlinear=="Non-linear"]`) of studies investigating non-linear relationship between climatic variables and measures of zoonotic disease risk (Fig. 1F).

### **Publication bias** 
```{r eggers_test}
f1 <- df %>% filter(!is.na(se) & !is.na(es))
f2 <- df %>% filter(!is.na(se) & !is.na(es)) %>% filter(Environmental_condition == "Temperature")
f3 <- df %>% filter(!is.na(se) & !is.na(es)) %>% filter(Environmental_condition == "Precipitation")
f4 <- df %>% filter(!is.na(se) & !is.na(es)) %>% filter(Environmental_condition == "Humidity")

regtest_all = regtest(f1$es, sei=f1$se)
regtest_temp = regtest(f2$es, sei=f2$se)
regtest_prec = regtest(f3$es, sei=f3$se)
regtest_hum = regtest(f4$es, sei=f4$se)

list_regtest = list(All = regtest_all$pval, Temperature = regtest_temp$pval, Precipitation = regtest_prec$pval, Humidity = regtest_hum$pval)
```

There was some degree of publication bias inferred from funnel plots showing standard errors against respective effect sizes (Fig. S3). Egger’s regression tests for funnel plot asymmetry showed significant asymmetry the for the overall dataset (z = `r round(regtest_all$zval,2)`, p = `r round(list_regtest$All,3)`) and precipitation data (z = `r round(regtest_prec$zval,2)`, p = `r round(list_regtest$Precipitation,3)`), but none within humidity and temperature data (Fig. S3, Table S7). Pearson’s product-moment correlation analysis showed no significant correlation between 5-Year Journal Impact Factors and Hedge’s g or reported p-values, even after removing outliers among Hedge’s g and p-values (Fig. S2). Furthermore, p-values extracted from the studies were examined to check for potential evidence of “p-hacking”. Visual inspection of the distribution of p-values surrounding p = 0.05 found limited evidence of p-hacking, with a small spike in the number of studies with p-values just under p = 0.05 (Fig. S4). 
