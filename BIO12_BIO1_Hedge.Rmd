---
output:
  pdf_document:
    highlight: tango
  html_document:
    df_print: paged
---

```{r include=FALSE}
library(tidyverse)
library(here)
library(knitr)
library(magrittr)
library(kableExtra)  # Load kableExtra for table styling
library(tidyverse)
library(MASS)         # For ordinal logistic regression
library(car)          # For the Brant test
library(ggplot2)      # For visualizations
library(knitr)        # For table formatting
library(kableExtra)   # For enhanced table styling

# Read in the data
df = read.csv(here('data', 'es_climvars_proportions.csv'))
```

# Statistical analysis

```{r warning=FALSE, echo=FALSE}
# Ensure 'es_cat' is a factor with ordered levels
df <- df %>%
  mutate(es_cat = factor(es_cat,
                         levels = c('Negative effect (g < -0.2)', 'Positive effect (g > 0.2)'),
                         ordered = TRUE))

df %<>% filter(es_cat!="No effect")
# Subset the data based on Environmental_condition
df_temp <- df %>%
  filter(Environmental_condition == "Temperature" & !is.na(es_cat))

df_prec <- df %>%
  filter(Environmental_condition == "Precipitation" & !is.na(es_cat))

```

```{r warning=FALSE, include=FALSE}
# Function to determine the appropriate statistical test based on the initial dataset
determine_initial_test <- function(data, effect_cat, bin_var, all_effect_cats) {
  # Create the initial contingency table
  cont_table <- table(data[[effect_cat]], data[[bin_var]])
  
  # Ensure all effect size categories are represented
  cont_table <- cont_table[all_effect_cats, , drop = FALSE]
  cont_table[is.na(cont_table)] <- 0
  
  # Perform Chi-Square Test to check assumptions
  chi_test <- tryCatch(chisq.test(cont_table), error = function(e) NULL)
  
  if (!is.null(chi_test) && all(chi_test$expected >= 5)) {
    return("Chi-Square Test")
  } else {
    return("Fisher's Exact Test")
  }
}


# Updated function to perform statistical tests with bootstrapping using a single test type
perform_stat_tests_subset_bootstrap_single_test <- function(data, effect_cat, agreement_var, bin_var, climate_type,
                                                            num_iterations = 1000,
                                                            sample_size = 0.8,
                                                            sampling_method = "bootstrap",
                                                            seed = 123) {
  
  # Initialize vectors to store results
  p_values <- numeric(num_iterations)
  test_stats <- numeric(num_iterations)
  
  # Set seed for reproducibility
  set.seed(seed)
  
  # Define all possible effect size categories (excluding "No effect")
  all_effect_cats <- c("Negative effect (g < -0.2)", "Positive effect (g > 0.2)")
  
  # Determine the appropriate test based on the initial dataset
  test_type <- determine_initial_test(data, effect_cat, bin_var, all_effect_cats)
  
  # Inform the user about the chosen test
  #cat(paste("Using", test_type, "for all bootstrapped iterations."))
  
  for (i in 1:num_iterations) {
    # Sample the data based on the selected method
    if (sampling_method == "bootstrap") {
      sample_data <- data %>% sample_frac(size = 1, replace = TRUE)  # Bootstrap: Sampling with replacement
    } else if (sampling_method == "random") {
      sample_data <- data %>% sample_frac(size = sample_size, replace = FALSE)  # Random subsample: e.g., 80% without replacement
    } else {
      stop("Invalid sampling method. Choose 'bootstrap' or 'random'.")
    }
    
    # Create contingency table
    cont_table <- table(sample_data[[effect_cat]], sample_data[[bin_var]])
    
    # Ensure all effect size categories are represented in the table
    cont_table <- cont_table[all_effect_cats, , drop = FALSE]
    cont_table[is.na(cont_table)] <- 0  # Replace NA with 0
    
    # Perform the chosen statistical test
    if (test_type == "Chi-Square Test") {
      test_result <- tryCatch(chisq.test(cont_table), error = function(e) NULL)
      if (!is.null(test_result)) {
        p_val <- test_result$p.value
        test_stat <- test_result$statistic
      } else {
        p_val <- NA
        test_stat <- NA
      }
    } else if (test_type == "Fisher's Exact Test") {
      test_result <- tryCatch(fisher.test(cont_table), error = function(e) NULL)
      if (!is.null(test_result)) {
        p_val <- test_result$p.value
        test_stat <- NA  # Fisher's Exact Test does not provide a Chi-Square statistic
      } else {
        p_val <- NA
        test_stat <- NA
      }
    }
    
    # Store results
    p_values[i] <- p_val
    test_stats[i] <- test_stat
  }
  
  # Summarize the results
  summary_results <- list(
    p_values = p_values,
    test_stats = test_stats,
    test_type = test_type,
    climate_type = climate_type
  )
  
  # Print summary
  cat("--------------------------\n")
  cat(paste("Climate Type:", climate_type, "| Agreement Variable:", agreement_var, "\n"))
  cat("----------------------------\n")
  
  #cat("\nStatistical Test Summary over", num_iterations, "iterations:\n")
  if (test_type == "Chi-Square Test") {
    cat("Chi-Square Tests performed:", num_iterations, "\n")
  } else {
    cat("Fisher's Exact Tests performed:", num_iterations, "\n")
  }
  
  cat("\nP-values Summary:\n")
  cat(sprintf("Mean p-value: %.4f\n", mean(p_values, na.rm = TRUE)))
  cat(sprintf("Median p-value: %.4f\n", median(p_values, na.rm = TRUE)))
  cat(sprintf("Proportion p < 0.05: %.2f%%\n", mean(p_values < 0.05, na.rm = TRUE) * 100))
  
  if (test_type == "Chi-Square Test") {
    cat("\nTest Statistics Summary (Chi-Square):\n")
    cat(sprintf("Mean Chi-Square: %.4f\n", mean(test_stats, na.rm = TRUE)))
    cat(sprintf("Median Chi-Square: %.4f\n", median(test_stats, na.rm = TRUE)))
  }
  
  return(summary_results)
}

summarize_bootstrap_results <- function(summary_results) {
  # Extract components
  p_values <- summary_results$p_values
  test_stats <- summary_results$test_stats
  test_type <- summary_results$test_type
  climate_type <- summary_results$climate_type
  
  # Initialize summary list
  summary_list <- list()
  
  # Include the type of test and climate type in the summary
  summary_list$test_type <- test_type
  summary_list$climate_type <- climate_type
  
  # Calculate Mean p-value
  mean_p <- mean(p_values, na.rm = TRUE)
  summary_list$mean_pval <- mean_p
  
  # Calculate 95% CI for p-values using t.test
  p_ci <- t.test(p_values, conf.level = 0.95)$conf.int
  summary_list$pval_CI_L <- p_ci[1]
  summary_list$pval_CI_U <- p_ci[2]
  
  # Calculate Proportion of p < 0.05
  prop_sig <- mean(p_values < 0.05, na.rm = TRUE) * 100  # in percentage
  summary_list$prop_sigif <- prop_sig
  
  # Handle Chi-Square or Fisher's Exact based on test type
  if (test_type == "Chi-Square Test") {
    # Remove NA values from test statistics
    valid_test_stats <- test_stats[!is.na(test_stats)]
    
    # Calculate Mean test statistic for Chi-Square Test
    mean_stat <- mean(valid_test_stats, na.rm = TRUE)
    summary_list$mean_test_stat <- mean_stat
    
    # Calculate 95% CI for test statistics using t.test
    stat_ci <- t.test(valid_test_stats, conf.level = 0.95)$conf.int
    summary_list$test_stat_CI_L <- stat_ci[1]
    summary_list$test_stat_CI_U <- stat_ci[2]
  } else {
    # For Fisher's Exact Test (or other tests without test statistics), skip this part
    summary_list$mean_test_stat <- NA
    summary_list$test_stat_CI_L <- NA
    summary_list$test_stat_CI_U <- NA
  }
  
  # Return the summary list
  return(summary_list)
}

# Function to perform statistical tests within a subset
perform_stat_tests_subset <- function(data, effect_cat, agreement_var, bin_var, climate_type) {
  
  # Create contingency table
  cont_table <- table(data[[effect_cat]], data[[bin_var]])
  
  # Check if all expected counts are >= 5
  chi_test <- chisq.test(cont_table)
  expected <- chi_test$expected
  if (all(expected >= 5)) {
    test_used <- "Chi-Square Test"
    test_result <- chi_test
  } else {
    test_used <- "Fisher's Exact Test"
    test_result <- fisher.test(cont_table)
  }
  
  # Compile results
  results <- list(
    contingency_table = cont_table,
    test_used = test_used,
    test_result = test_result
  )
  
  # Print the results
  cat("\n============================\n")
  cat(paste("Climate Type:", climate_type, "| Agreement Variable:", agreement_var, "\n"))
  cat("============================\n")
  
  cat("\nContingency Table:\n")
  print(cont_table)
  
  cat("\n", test_used, "Results:\n")
  print(test_result)

  return(results)
}

# Function to create a nicely formatted contingency table
create_contingency_table <- function(data, effect_cat, bin_var, all_effect_cats) {
  # Create the initial contingency table
  cont_table <- table(data[[effect_cat]], data[[bin_var]])
  
  # Ensure all effect size categories are represented
  cont_table <- cont_table[all_effect_cats, , drop = FALSE]
  cont_table[is.na(cont_table)] <- 0
  
  # Reorder columns to ensure '<' comes first, then range, then '>'
  col_order <- order(sapply(colnames(cont_table), function(x) {
    if (grepl('<.*<', x)) {
      return(2)
    } else if (grepl('<', x) && !grepl('>', x)) {
      return(1)
    } else if (grepl('>', x) && !grepl('<', x)) {
      return(3)
    } else {
      return(4) # for any other category that doesn't match
    }
  }))
  cont_table <- cont_table[, col_order, drop = FALSE]
  
  # Convert the table to a matrix and add row and column names
  cont_table_matrix <- as.matrix(cont_table)
  rownames(cont_table_matrix) <- rownames(cont_table)
  
  # Format the contingency table nicely using kable
  cont_table_matrix %>%
    kable(caption = "Contingency table used in the stat. test") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
}

# Apply the function to temperature agreement variables
all_effect_cats <- c("Negative effect (g < -0.2)", "Positive effect (g > 0.2)")
```

```{r warning=FALSE, include=FALSE}
# Load the necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(reshape2)
library(gridExtra)
library(here)

# Function to create contingency tables ensuring all categories are represented
create_cont_table <- function(data, effect_cat, bin_var) {
  
  #cont_table <- table(data[[effect_cat]], data[[bin_var]])
  # Define all possible categories for effect size and bin variables
  #all_effect_cats <- c("Negative effect (g < -0.2)", "No effect", "Positive effect (g > 0.2)")
  all_effect_cats <- c("Negative effect (g < -0.2)", "Positive effect (g > 0.2)")
  all_bins <- unique(data[[bin_var]]) # Get all unique bins from the data
  
  data %>%
    count(!!sym(effect_cat), !!sym(bin_var)) %>%
    complete(!!sym(effect_cat) := all_effect_cats, !!sym(bin_var) := all_bins, fill = list(n = 0)) %>%
    pivot_wider(names_from = !!sym(bin_var), values_from = n, values_fill = 0)
}

# Create contingency tables for all climate categories
cont_temp_2 <- create_cont_table(df_temp , "es_cat", "bio1_most_frequent_2")
cont_temp_2 %<>% rename("> 2ºC" = "bio1 > 2", "< 2ºC" = "bio1 < 2")

cont_temp_15 <- create_cont_table(df_temp , "es_cat", "bio1_most_frequent_15")
cont_temp_15 %<>% rename("> 1.5ºC" = "bio1 > 1.5", "< 1.5ºC" = "bio1 < 1.5")

cont_temp_1 <- create_cont_table(df_temp , "es_cat", "bio1_most_frequent_1")
cont_temp_1 $`bio1 < 1` = 0
cont_temp_1 %<>% rename("> 1ºC" = "bio1 > 1", "< 1ºC" = "bio1 < 1")

cont_temp_05 <- create_cont_table(df_temp, "es_cat", "bio1_most_frequent_05")
cont_temp_05 $`bio1 < 0.5` = 0
cont_temp_05 %<>% rename("> 0.5ºC" = "bio1 > 0.5", "< 0.5ºC" = "bio1 < 0.5")

cont_precip_100 <- create_cont_table(df_prec %>% filter(bio12_most_frequent_100cat!="-100 < bio12 < 100"), "es_cat", "bio12_most_frequent_100cat")
cont_precip_100 %<>% rename("< -100mm" = "bio12 < -100", "> +100mm" = "bio12 > 100")

cont_precip_50 <- create_cont_table(df_prec %>% filter(bio12_most_frequent_50cat!="-50 < bio12 < 50"), "es_cat", "bio12_most_frequent_50cat")
cont_precip_50 %<>% rename("< -50mm" = "bio12 < -50", "> +50mm" = "bio12 > 50")

cont_precip_25 <- create_cont_table(df_prec %>% filter(bio12_most_frequent_25cat!="-25 < bio12 < 25"), "es_cat", "bio12_most_frequent_25cat")
cont_precip_25 %<>% rename("< -25mm" = "bio12 < -25", "> +25mm" = "bio12 > 25")

# Function to create a heatmap from a contingency table with ordered x-axis and customizable color
# Now with text labels on the tiles
create_heatmap <- function(cont_table, climate_type, x_label, y_label, low_color = "white", high_color = "steelblue") {
  
  # Reshape the data for ggplot2
  cont_long <- cont_table %>%
    pivot_longer(-es_cat, names_to = "Agreement_Bin", values_to = "Count")
  
  # Specify the order of the x-axis bins
  cont_long$Agreement_Bin <- factor(cont_long$Agreement_Bin)
  cont_long$es_cat[cont_long$es_cat=="Negative effect (g < -0.2)"] = "Negative effect\n(g < -0.2)" 
  cont_long$es_cat[cont_long$es_cat=="Positive effect (g > 0.2)"] = "Positive effect\n(g > 0.2)"
  # Create the heatmap with customizable colors and text labels
  heatmap_plot <- ggplot(cont_long, aes(x = Agreement_Bin, y = es_cat, fill = Count)) +
    geom_tile(color = "black") +
    geom_text(aes(label = Count), color = "black", size = 4, alpha = 0.9) +  # Add text labels for the count values
    scale_fill_gradient2(low = low_color, high = high_color, midpoint = 0) +
    labs(title = paste("Heatmap:", climate_type),
         x = x_label,
         y = y_label,
         fill = "Count") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 10, hjust = 1, size = 11),
          axis.text.y = element_text(angle = 10, hjust = 1, size = 11),
         legend.position = "none")
  
  return(heatmap_plot)
}
```


## Temperature

```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Perform bootstrapped statistical tests for Temperature (>1ºC)
temp_results_2_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_temp,
  effect_cat = "es_cat",
  agreement_var = "bio1_most_frequent_2",
  bin_var = "bio1_most_frequent_2",
  climate_type = "Temperature (2ºC change)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)

# Call the function to create and display the contingency table
create_contingency_table(df_temp, "es_cat", "bio1_most_frequent_2", all_effect_cats)

heatmap_temp_2 <- create_heatmap(cont_temp_2, 
                                   "Temperature (+- 2ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")

print(heatmap_temp_2)
```

\newpage

```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Perform bootstrapped statistical tests for Temperature (>1ºC)
temp_results_15_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_temp,
  effect_cat = "es_cat",
  agreement_var = "bio1_most_frequent_15",
  bin_var = "bio1_most_frequent_15",
  climate_type = "Temperature (1.5ºC change)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_temp, "es_cat", "bio1_most_frequent_15", all_effect_cats)

heatmap_temp_15 <- create_heatmap(cont_temp_15, 
                                   "Temperature (+- 1.5ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")
print(heatmap_temp_15)
```

\newpage

```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Perform bootstrapped statistical tests for Temperature (>1ºC)
temp_results_1_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_temp,
  effect_cat = "es_cat",
  agreement_var = "bio1_most_frequent_1",
  bin_var = "bio1_most_frequent_1",
  climate_type = "Temperature (1ºC change)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_temp, "es_cat", "bio1_most_frequent_1", all_effect_cats)

heatmap_temp_1 <- create_heatmap(cont_temp_1, 
                                   "Temperature (+- 1ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")
print(heatmap_temp_1)
```

\newpage

```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Apply the function to temperature agreement variables
temp_results_05_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_temp,
  effect_cat = "es_cat",
  agreement_var = "bio1_most_frequent_05",
  bin_var = "bio1_most_frequent_05",
  climate_type = "Temperature (0.5ºC change)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_temp, "es_cat", "bio1_most_frequent_05", all_effect_cats)

heatmap_temp_05 <- create_heatmap(cont_temp_05, 
                                   "Temperature (+- 0.5ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4",
                                   low_color = "ivory")
print(heatmap_temp_05)
```
\newpage

## Precipitation

```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Apply the function to precipitation agreement variables
precip_results_100_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_prec,#  %>% filter(bio12_most_frequent_100cat!="-100 < bio12 < 100"),
  effect_cat = "es_cat",
  agreement_var = "bio12_most_frequent_100cat",
  bin_var = "bio12_most_frequent_100cat",
  climate_type = "Precipitation (+- 100mm)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_prec, "es_cat", "bio12_most_frequent_100cat", all_effect_cats)

heatmap_precip_100 <- create_heatmap(cont_precip_100, 
                                      "Precipitation (+- 100mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

print(heatmap_precip_100)

```
\newpage
```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Apply the function to precipitation agreement variables
precip_results_50_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_prec, #%>% filter(bio12_most_frequent_50cat!="-50 < bio12 < 50"),
  effect_cat = "es_cat",
  agreement_var = "bio12_most_frequent_50cat",
  bin_var = "bio12_most_frequent_50cat",
  climate_type = "Precipitation (+- 50mm)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_prec, "es_cat", "bio12_most_frequent_50cat", all_effect_cats)

heatmap_precip_50 <- create_heatmap(cont_precip_50, 
                                      "Precipitation (+- 50mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

print(heatmap_precip_50)
```
\newpage
```{r echo=FALSE, fig.height=3.5, fig.width=5, warning=FALSE,fig.align = "center"}
# Apply the function to precipitation agreement variables
precip_results_25_boot <- perform_stat_tests_subset_bootstrap_single_test(
  data = df_prec,# %>% filter(bio12_most_frequent_25cat!="-25 < bio12 < 25"),
  effect_cat = "es_cat",
  agreement_var = "bio12_most_frequent_25cat",
  bin_var = "bio12_most_frequent_25cat",
  climate_type = "Precipitation (+- 25mm)",
  num_iterations = 1000,
  sample_size = 0.8,
  sampling_method = "bootstrap",  # or "random"
  seed = 123
)
create_contingency_table(df_prec, "es_cat", "bio12_most_frequent_25cat", all_effect_cats)

heatmap_precip_25 <- create_heatmap(cont_precip_25, 
                                      "Precipitation (+- 25mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

print(heatmap_precip_25)
```
\newpage
```{r echo=FALSE, warning=FALSE}
# Assuming you have multiple lists (bootstrap results) like these:
results_list <- list(
  temp_05 = summarize_bootstrap_results(temp_results_05_boot),
  temp_1 = summarize_bootstrap_results(temp_results_1_boot),
  temp_15 = summarize_bootstrap_results(temp_results_15_boot),
  temp_2 = summarize_bootstrap_results(temp_results_2_boot),
  precip_25 = summarize_bootstrap_results(precip_results_25_boot),
  precip_50 = summarize_bootstrap_results(precip_results_50_boot),
  precip_100 = summarize_bootstrap_results(precip_results_100_boot)
)

# Convert each list into a data frame with an additional column indicating the name
df_results <- do.call(rbind, lapply(names(results_list), function(name) {
  result <- results_list[[name]]
  data.frame(list_name = name, result, stringsAsFactors = FALSE)
}))

# Assuming you have your results data frame `df_results`
df_results <- df_results %>%
  mutate(across(where(is.numeric), round, digits = 2))

df_results$test_type[df_results$test_type=="Chi-Square Test"] = "Chi-Square"
df_results$test_type[df_results$test_type=="Fisher's Exact Test"] = "Fisher's Exact"

# View the combined data frame
#print(df_results)
# Display the summary table
names(df_results) = c("list_name", "TestType", "ClimVar", "MeanPVal", "PVal.CI.Lo", "PVal.CI.Up", "PropPValSignif", "MeanStat", "StatCI.Lo","StatCI.Up")

kableExtra::kable(df_results %>% dplyr::select(-list_name, -StatCI.Lo, -StatCI.Up), caption = "Summary of Statistical Tests", linesep = "\\addlinespace") %>%
   kable_styling(position = "left", full_width = TRUE, font_size=9, latex_options = "striped") %>% 
  column_spec(1, width = "2.5cm") %>%
  column_spec(2, width = "4.5cm") %>% 
  column_spec(3, width = "1.7cm") %>% 
  column_spec(4, width = "1.7cm") %>%
  column_spec(5, width = "1.7cm") %>% 
  column_spec(6, width = "1.7cm") %>% 
  column_spec(7, width = "1.7cm")
```

```{r eval=FALSE, include=FALSE}
# Generate heatmaps for each climate category
heatmap_temp_2 <- create_heatmap(cont_temp_2, 
                                   "Temperature (+- 2ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")

heatmap_temp_15 <- create_heatmap(cont_temp_15, 
                                   "Temperature (+- 1.5ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")

heatmap_temp_1 <- create_heatmap(cont_temp_1, 
                                   "Temperature (+- 1ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4", 
                                   low_color = "ivory")

heatmap_temp_05 <- create_heatmap(cont_temp_05, 
                                   "Temperature (+- 0.5ºC)", 
                                   "Consensus temperature change",
                                   "Effect Size Category",
                                   high_color = "orangered4",
                                   low_color = "ivory")

heatmap_precip_100 <- create_heatmap(cont_precip_100, 
                                      "Precipitation (+- 100mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

heatmap_precip_50 <- create_heatmap(cont_precip_50, 
                                      "Precipitation (+- 50mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

heatmap_precip_25 <- create_heatmap(cont_precip_25, 
                                      "Precipitation (+- 25mm)", 
                                      "Consensus precipitation change",
                                      "Effect Size Category",
                                      high_color = "slateblue4",
                                      low_color = "ivory")

```

```{r eval=FALSE, include=FALSE}
# Display individual heatmaps
print(heatmap_temp_2)
print(heatmap_temp_15)
print(heatmap_temp_1)
print(heatmap_temp_05)

# Load patchwork
library(patchwork)

# Combine the four heatmaps in a 2x2 grid using patchwork
combined_heatmaps_temperature <- (heatmap_temp_1 + heatmap_temp_15 + heatmap_temp_2)/(heatmap_precip_25 + heatmap_precip_50 + heatmap_precip_100) +
                     #plot_layout(guides = "collect") & 
                     theme(plot.margin = margin(1, 1, 1))  # Adjust margins

# Print the combined plot
print(combined_heatmaps_temperature)



print(heatmap_precip_100)
print(heatmap_precip_50)
print(heatmap_precip_25)

# Load gridExtra
library(gridExtra)

# Install cowplot package if you don't have it already
if (!require(cowplot)) install.packages("cowplot", dependencies=TRUE)

# Load cowplot
library(cowplot)

combined_heatmaps <- plot_grid(
  heatmap_temp_1, heatmap_temp_05, heatmap_precip_50, heatmap_precip_25,
  labels = c("A", "B", "C", "D"),  # Optional: Add labels to each plot
  ncol = 2,  # Number of columns
  align = "v",  # Align vertically if necessary
  label_size = 10,  # Adjust label size
  rel_widths = c(10, 10),  # Relative widths for the plots (adjust to control spacing)
  rel_heights = c(1, 1)  # Relative heights for rows (adjust to control spacing)
)

# Print the combined heatmap
print(combined_heatmaps)

# Load patchwork
library(patchwork)

# Combine the four heatmaps in a 2x2 grid using patchwork
combined_heatmaps <- (heatmap_temp_1 + heatmap_temp_05) / 
                     (heatmap_precip_50 + heatmap_precip_25) +
                     #plot_layout(guides = "collect") & 
                     theme(plot.margin = margin(1, 1, 1, 1))  # Adjust margins

# Print the combined plot
print(combined_heatmaps)

# Save the combined heatmap as an image
#ggsave("combined_4_heatmaps_patchwork.png", plot = combined_heatmaps, width = 12, height = 8)

# Save the combined heatmap as an image
#ggsave("combined_heatmaps.png", plot = combined_heatmaps, width = 12, height = 8)
# If you want to save the combined heatmap as an image
#ggsave("combined_heatmaps.png", plot = combined_heatmaps, width = 12, height = 8)
```
